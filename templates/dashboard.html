{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="mb-4">📦 Inventory Dashboard</h1>

<!-- ────────── KPI CARDS ────────── -->
<div class="row text-center mb-4">
  <div class="col-md-4 mb-2">
    <div class="card shadow-sm border-0"><div class="card-body"><h6 class="text-muted">Total SKUs</h6><h2 id="kpi-skus">{{ summary.total_skus }}</h2></div></div>
  </div>
  <div class="col-md-4 mb-2">
    <div class="card shadow-sm border-0"><div class="card-body"><h6 class="text-muted">Total Quantity</h6><h2 id="kpi-qty">{{ summary.total_quantity }}</h2></div></div>
  </div>
  <div class="col-md-4 mb-2">
    <div class="card shadow-sm border-0"><div class="card-body"><h6 class="text-muted">Low‑stock Items (≤1)</h6><h2 id="kpi-low" class="text-danger">{{ summary.low_stock_items }}</h2></div></div>
  </div>
</div>

{% if role == 'HQ' %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const summaries = {
    hq: {{ hq_summary | tojson }},
    mbella: {{ mbella_summary | tojson }},
    citibella: {{ citibella_summary | tojson }}
  };
  const render = loc => {
    document.getElementById('kpi-skus').textContent = summaries[loc].total_skus;
    document.getElementById('kpi-qty').textContent  = summaries[loc].total_quantity;
    document.getElementById('kpi-low').textContent  = summaries[loc].low_stock_items;
  };
  render('hq');
  document.querySelector('[data-bs-target="#hq-tab"]').addEventListener('shown.bs.tab',()=>render('hq'));
  document.querySelector('[data-bs-target="#mbella-tab"]').addEventListener('shown.bs.tab',()=>render('mbella'));
  document.querySelector('[data-bs-target="#citibella-tab"]').addEventListener('shown.bs.tab',()=>render('citibella'));
});
</script>
{% endif %}

<!-- ────────── PRODUCT SEARCH + RESET ────────── -->
<div class="mb-4">
  <label for="product-search" class="form-label">🔍 Search Product</label>
  <div class="input-group">
    <input list="product-list" id="product-search" class="form-control" placeholder="Type product name and press Enter" />
    <button class="btn btn-outline-secondary" id="reset-search" type="button">Back</button>
  </div>
  <datalist id="product-list">
    {% for name in product_names %}<option value="{{ name }}">{% endfor %}
  </datalist>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('product-search');
  const resetBtn    = document.getElementById('reset-search');
  const tables      = document.querySelectorAll('table');

  const showAll = () => {
    tables.forEach(tbl=>tbl.querySelectorAll('tbody tr').forEach(r=>r.style.display=''));
  };

  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const q = searchInput.value.trim().toLowerCase();
      tables.forEach(tbl=>{
        tbl.querySelectorAll('tbody tr').forEach(row=>{
          const cell = row.querySelector('td');
          if(cell){
            const name = cell.textContent.toLowerCase();
            row.style.display = !q || name.includes(q) ? '' : 'none';
          }
        });
      });
    }
  });

  resetBtn.addEventListener('click', () => {
    searchInput.value='';
    showAll();
    searchInput.focus();
  });
});
</script>

<!-- ──────── ACTION BUTTONS ──────── -->
<div class="mb-3 d-flex flex-wrap gap-2">
  <a href="/add_product" class="btn btn-primary">➕ Add New Product</a>
  <a href="/restock" class="btn btn-primary">📥 Restock</a>
  <a href="/transfer" class="btn btn-primary">🔁 Transfer Stock</a>
  {% if role == 'HQ' %}
    <a href="{{ url_for('manage_products') }}" class="btn btn-primary">📋 Manage Products</a>
  {% endif %}
  {% if role in ['Mbella', 'Citibella'] %}
    <a href="{{ url_for('use_product') }}" class="btn btn-primary">➕ Log Product Usage</a>
  {% endif %}
</div>

<!-- ──────── EXPORT BUTTONS ──────── -->
<div class="mb-4 d-flex flex-wrap gap-2">
  <a href="/export/inventory" class="btn btn-y2k-outline mt-3">⬇️ Export Full Inventory</a>
  <a href="/export/movements" class="btn btn-y2k-outline mt-3">⬇️ Export Movement History</a>
  {% if role == 'HQ' %}
    <a href="/export/low_stock" class="btn btn-y2k-outline mt-3">⬇️ Export Low‑Stock List</a>
  {% endif %}
</div>

<!-- ──────── LOW STOCK TABLE ──────── -->
{% if low_stock_items %}
  <h5 class="mt-4">🔻 Low Stock Items</h5>
  <table class="table table-sm table-danger">
    <thead>
      <tr><th>Product</th><th>Location</th><th>Quantity</th><th>Reorder Level</th></tr>
    </thead>
    <tbody>
      {% for item in low_stock_items %}
        <tr>
          <td>{{ item.product_name }}</td>
          <td>{{ item.location_name }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.reorder_level }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

<!-- ──────── INVENTORY TABS (MOVED BELOW EXPORT) ──────── -->
{% if role == 'HQ' %}
<div class="card mt-4">
  <div class="card-header pb-0">
    <ul class="nav nav-tabs card-header-tabs" id="inventoryTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#hq-tab" type="button">HQ</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mbella-tab" type="button">Mbella</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#citibella-tab" type="button">Citibella</button>
      </li>
    </ul>
  </div>

  <div class="card-body tab-content">
    <div class="tab-pane fade show active" id="hq-tab">
      {% set inventory = hq_stock %}
      <h5 class="card-title">🏢 HQ Inventory</h5>
      <table class="table" id="hq-table">{% include 'inventory_table.html' %}</table>
    </div>
    <div class="tab-pane fade" id="mbella-tab">
      {% set inventory = mbella_stock %}
      <h5 class="card-title">💇‍♀️ Mbella Inventory</h5>
      <table class="table" id="mbella-table">{% include 'inventory_table.html' %}</table>
    </div>
    <div class="tab-pane fade" id="citibella-tab">
      {% set inventory = citibella_stock %}
      <h5 class="card-title">💅 Citibella Inventory</h5>
      <table class="table" id="citibella-table">{% include 'inventory_table.html' %}</table>
    </div>
  </div>
</div>
{% else %}
  <!-- ──────── SINGLE INVENTORY FOR BRANCH STAFF ──────── -->
  <div class="w-100 my-4 text-center">
    <h4>{{ role }} Inventory</h4>
  </div>
  <table class="table table-bordered table-striped" id="branch-table">
    <thead class="table-dark">
      <tr><th>Product</th><th>Location</th><th>Quantity</th></tr>
    </thead>
    <tbody>
      {% for row in inventory %}
        <tr><td>{{ row.product_name }}</td><td>{{ row.location_name }}</td><td>{{ row.quantity }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

<!-- ────────── RECENT MOVEMENTS ────────── -->
<div class="card mt-4">
  <div class="card-header py-2">
    <h5 class="mb-0">🔄 Recent Movements</h5>
  </div>
  <div class="card-body p-0">
    <table class="table table-sm table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Product</th><th>From</th><th>To</th><th>Qty</th><th>By</th><th>Time</th>
        </tr>
      </thead>
      <tbody>
        {% for mv in recent_movements %}
        <tr>
          <td>{{ 'MV-%04d' | format(mv.id) }}</td>
          <td>{{ mv.product_name }}</td>
          <td>{{ mv.from_loc }}</td>
          <td>{{ mv.to_loc }}</td>
          <td>{{ mv.quantity }}</td>
          <td>{{ mv.moved_by }}</td>
          <td>{{ mv.date_moved.strftime('%d %b %Y %H:%M') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ────────── DASHBOARD FOOTER BUTTONS ────────── -->
<div class="mt-5 text-start">
  {% if role == 'HQ' %}
  <a href="/export/products" class="btn btn-outline-dark me-2 mb-2">⬇️ Export Products Table (CSV)</a>
  {% endif %}
  <a href="{{ url_for('view_movements') }}" class="btn btn-outline-secondary mb-2">📦 View Full Movement History</a>
</div>
{% endblock %}
