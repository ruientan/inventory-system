{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>üîÅ Transfer Stock</h2>

    {% if invoice_filename %}
        <a href="{{ url_for('view_invoice', filename=invoice_filename) }}" target="_blank" class="btn btn-outline-primary mt-3">
            üìÑ View / Print Invoice
        </a>
        <a href="{{ url_for('download_invoice', filename=invoice_filename) }}" class="btn btn-outline-info mt-3">
            ‚¨áÔ∏è Download Invoice
        </a>
    {% endif %}

    
    <form method="POST" onsubmit="return validateForm()">

        <div class="mb-3">
            <label class="form-label">From Location:</label>
            <select name="from_location" class="form-select" required>
                {% for loc in locations %}
                <option value="{{ loc.location_id }}">{{ loc.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">To Location:</label>
            <select name="to_location" class="form-select" required>
                {% for loc in locations %}
                <option value="{{ loc.location_id }}">{{ loc.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="product-rows">
            <div class="product-row row mb-2">
                <div class="col">
                    <input list="product_list" name="product_name[]" class="form-control" placeholder="Product Name" required>
                </div>
                <div class="col">
                    <input type="number" name="quantity[]" class="form-control" placeholder="Quantity" required>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-danger" onclick="removeRow(this)">‚ùå</button>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-secondary mb-3" onclick="addRow()">‚ûï Add Another Product</button>

        <div class="mb-3">
            <label class="form-label">Moved By:</label>
            <input type="text" name="moved_by" class="form-control" required>
        </div>

        <button type="submit" class="btn btn-warning">üîÅ Transfer</button>
        <a href="/" class="btn btn-outline-secondary ms-2">‚Üê Back to Dashboard</a>
    </form>

    <datalist id="product_list">
        {% for p in products %}
        <option value="{{ p.product_name }}">
        {% endfor %}
    </datalist>
</div>

<script>
const hqStock = {{ hq_quantity | tojson | safe }};
function addRow() {
    const row = document.createElement('div');
    row.className = 'product-row row mb-2';
    row.innerHTML = `
        <div class="col">
            <input list="product_list" name="product_name[]" class="form-control" placeholder="Product Name" required>
        </div>
        <div class="col">
            <input type="number" name="quantity[]" class="form-control" placeholder="Quantity" required>
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-danger" onclick="removeRow(this)">‚ùå</button>
        </div>
    `;
    document.getElementById('product-rows').appendChild(row);
}

function removeRow(button) {
    const allRows = document.querySelectorAll('.product-row');
    if (allRows.length > 1) {
        button.closest('.product-row').remove();
    } else {
        alert("‚ö†Ô∏è At least one product row is required.");
    }
}

function validateForm() {
    const productInputs = document.querySelectorAll('input[name="product_name[]"]');
    const quantityInputs = document.querySelectorAll('input[name="quantity[]"]');
    const productNames = [];
    
    for (let i = 0; i < productInputs.length; i++) {
        const name = productInputs[i].value.trim().toLowerCase();
        const qty = quantityInputs[i].value.trim();

        if (!name || !qty) {
            alert("‚ö†Ô∏è All product names and quantities must be filled in.");
            return false;
        }

        if (productNames.includes(name)) {
            alert("‚ö†Ô∏è Duplicate product detected: " + productInputs[i].value + ". Please remove duplicates.");
            return false;
        }

        const available = hqStock[name] || 0;
        if (parseInt(qty) > available) {
            alert(`‚ùå Not enough stock for "${productInputs[i].value}". Available: ${available}, Requested: ${qty}`);
            return false;
        }

        if (parseInt(qty) <= 0) {
            alert("‚ö†Ô∏è Quantity must be greater than 0.");
            return false;
        }

        productNames.push(name);
    }
    return true;
}

</script>
{% endblock %}